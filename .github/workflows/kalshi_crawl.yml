name: Kalshi Crawl + Fan-out (auto-create repos)

on:
  workflow_dispatch:
  schedule:
    # Every 6 hours (UTC). Adjust as needed.
    - cron: "0 */6 * * *"

concurrency:
  group: kalshi-crawl-fanout
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout orchestrator repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Crawl + fan-out push (auto-create repos)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          KALSHI_BASE_URL: "https://api.elections.kalshi.com/trade-api/v2"
          KALSHI_SLEEP_SEC: "0.05"
          KALSHI_LOG_EVERY: "50"
          KALSHI_EVENT_BACKFILL_SEC: "172800"
          KALSHI_MARKET_BACKFILL_SEC: "120"
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          python scripts/kalshi_crawl_and_fanout.py

      - name: Commit & push orchestrator updates (state/targets/stats)
        run: |
          if git diff --quiet; then
            echo "No orchestrator changes."
            exit 0
          fi
          git config user.name "${GIT_AUTHOR_NAME:-github-actions[bot]}"
          git config user.email "${GIT_AUTHOR_EMAIL:-github-actions[bot]@users.noreply.github.com}"
          git add -A
          git commit -m "kalshi: update state/targets (auto)"
          git push
